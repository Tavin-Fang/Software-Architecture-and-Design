{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h3 class="text-center">我的租借</h3>

    <h4 class="mt-4 font-weight-bold">当前租借的设备</h4>
    <hr>
    {% if borrowed_devices %}
        <table class="table table-striped table-bordered mt-3">
            <thead>
                <tr>
                    <th>设备编号</th>
                    <th>设备名称</th>
                    <th>实验室</th>
                    <th>租借时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for record in borrowed_devices %}
                    <tr>
                        <td>{{ record.device.device_id }}</td>
                        <td>{{ record.device.name }}</td>
                        <td>{{ record.device.lab }}</td>
                        <td>{{ record.borrow_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td>
                            <form action="{{ url_for('return_device', device_id=record.device.id) }}" method="post" class="return-device-form">
                                <button type="submit" class="btn btn-warning btn-sm">归还设备</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="text-center mt-4">您当前没有正在租借的设备。</p>
    {% endif %}
 <hr>
    <h4 class="mt-5 font-weight-bold">租借历史记录</h4>
    <hr>
    {% if borrow_history %}
        <table class="table table-striped table-bordered mt-3">
            <thead>
                <tr>
                    <th>设备编号</th>
                    <th>设备名称</th>
                    <th>实验室</th>
                    <th>租借时间</th>
                    <th>归还时间</th>
                </tr>
            </thead>
            <tbody>
                {% for record in borrow_history %}
                    <tr>
                        <td>{{ record.device.device_id }}</td>
                        <td>{{ record.device.name }}</td>
                        <td>{{ record.device.lab }}</td>
                        <td>{{ record.borrow_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td>{{ record.return_time.strftime('%Y-%m-%d %H:%M:%S') if record.return_time else '未归还' }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="text-center mt-4">您没有任何租借历史记录。</p>
    {% endif %}

    <div class="text-center mt-3">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">返回首页</a>
    </div>
</div>

<script>
    // 使用AJAX提交归还设备表单，避免页面跳转
    document.querySelectorAll('.return-device-form').forEach(form => {
        form.addEventListener('submit', function (event) {
            event.preventDefault(); // 阻止表单默认提交行为
            fetch(this.action, {
                method: this.method,
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams(new FormData(this))
            }).then(response => {
                if (response.ok) {
                    alert('设备已成功归还！');
                    location.reload(); // 刷新页面以更新设备列表
                } else {
                    alert('归还设备失败，请重试！');
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('归还设备失败，请检查网络连接！');
            });
        });
    });
</script>
{% endblock %}
